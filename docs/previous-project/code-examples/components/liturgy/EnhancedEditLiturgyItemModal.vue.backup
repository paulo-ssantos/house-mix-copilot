<!--
  Enhanced EditLiturgyItemModal with AI-Powered Analysis
  
  New Features:
  - AI liturgy program analysis from raw text
  - Automatic moment identification and classification  
  - Portuguese church terminology optimization
  - Timing indicators for late/advance visual feedback
  - Manual override capabilities for AI suggestions
  - Resource discovery integration ready
-->
<template>
  <UModal v-model="isOpen" :ui="{ width: 'max-w-5xl' }">
    <UCard>
      <template #header>
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">
            <span v-if="!showAIAnalysis">‚úèÔ∏è Edit Liturgy Item</span>
            <span v-else>ü§ñ AI Liturgy Analysis</span>
          </h3>
          <div class="flex items-center space-x-2">
            <!-- AI Analysis Toggle -->
            <UButton
              :icon="showAIAnalysis ? 'i-heroicons-pencil-square' : 'i-heroicons-cpu-chip'"
              size="sm"
              :color="showAIAnalysis ? 'gray' : 'primary'"
              variant="ghost"
              @click="toggleAIAnalysis"
              :title="showAIAnalysis ? 'Switch to Manual Edit' : 'Switch to AI Analysis'"
            />
            <UButton
              icon="i-heroicons-x-mark"
              size="sm"
              color="gray"
              variant="ghost"
              @click="closeModal"
            />
          </div>
        </div>
      </template>

      <!-- AI Analysis Panel -->
      <div v-if="showAIAnalysis" class="space-y-6">
        <!-- Raw Liturgy Program Input -->
        <UFormGroup 
          label="Cole o Programa de Culto Completo" 
          description="Cole aqui o texto completo do programa de culto para an√°lise autom√°tica com IA"
        >
          <UTextarea
            v-model="liturgyProgramText"
            placeholder="Exemplo:&#10;PROGRAMA DE CULTO - DOMINGO 19:00H&#10;19:00 - PREL√öDIO MUSICAL - Minist√©rio de M√∫sica&#10;19:05 - ABERTURA DO CULTO - Pastor Jo√£o Silva&#10;19:10 - C√ÇNTICOS CONGREGACIONAIS..."
            rows="8"
            class="font-mono text-sm"
            :ui="{ wrapper: 'relative' }"
          />
        </UFormGroup>

        <!-- AI Analysis Actions -->
        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-center space-x-2">
            <UIcon name="i-heroicons-cpu-chip" class="w-5 h-5 text-blue-600" />
            <div>
              <p class="font-medium text-blue-900">An√°lise com IA Jina.ai</p>
              <p class="text-sm text-blue-700">
                Identifica√ß√£o autom√°tica de momentos, hor√°rios e respons√°veis
              </p>
            </div>
          </div>
          
          <UButton
            color="primary"
            :loading="isAnalyzing"
            :disabled="!liturgyProgramText.trim()"
            @click="analyzeLiturgyProgram"
          >
            <template #leading>
              <UIcon name="i-heroicons-sparkles" />
            </template>
            Analisar com IA
          </UButton>
        </div>

        <!-- Analysis Results -->
        <div v-if="aiAnalysisResults.length > 0" class="space-y-4">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-lg">
              üéØ Momentos Identificados ({{ aiAnalysisResults.length }})
            </h4>
            <div class="flex items-center space-x-2">
              <UBadge :color="aiAnalysisResults.length > 0 ? 'green' : 'gray'">
                {{ aiAnalysisResults.length }} momentos
              </UBadge>
              <UButton
                size="sm"
                color="primary"
                variant="soft"
                @click="applyAllAIResults"
                :disabled="aiAnalysisResults.length === 0"
              >
                Aplicar Todos
              </UButton>
            </div>
          </div>

          <!-- AI Results List -->
          <div class="grid grid-cols-1 gap-3 max-h-96 overflow-y-auto">
            <div
              v-for="(result, index) in aiAnalysisResults"
              :key="index"
              class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors"
            >
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <!-- Moment Header -->
                  <div class="flex items-center space-x-2 mb-2">
                    <UBadge
                      :color="getTypeColor(result.type)"
                      variant="soft"
                      size="sm"
                    >
                      {{ getTypeLabel(result.type) }}
                    </UBadge>
                    
                    <!-- Confidence Score -->
                    <UBadge
                      :color="result.confidence > 0.7 ? 'green' : result.confidence > 0.4 ? 'yellow' : 'red'"
                      variant="soft"
                      size="sm"
                    >
                      {{ Math.round(result.confidence * 100) }}% confian√ßa
                    </UBadge>
                    
                    <!-- Timing Indicator -->
                    <span 
                      v-if="result.startTime"
                      class="px-2 py-1 text-xs font-mono bg-gray-100 rounded"
                    >
                      {{ result.startTime }}
                    </span>
                  </div>

                  <!-- Moment Details -->
                  <h5 class="font-medium text-gray-900 mb-1">
                    {{ result.title }}
                  </h5>
                  
                  <p 
                    v-if="result.description" 
                    class="text-sm text-gray-600 mb-2"
                  >
                    {{ result.description }}
                  </p>

                  <!-- Responsible Person -->
                  <p 
                    v-if="result.responsible"
                    class="text-xs text-gray-500"
                  >
                    üë§ {{ result.responsible }}
                  </p>
                </div>

                <!-- Actions -->
                <div class="flex flex-col space-y-1 ml-4">
                  <UButton
                    size="xs"
                    color="primary"
                    variant="soft"
                    @click="applyAIResult(result, index)"
                  >
                    Aplicar
                  </UButton>
                  
                  <UButton
                    size="xs"
                    color="gray"
                    variant="ghost"
                    @click="editAIResult(result, index)"
                  >
                    Ajustar
                  </UButton>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analysis Error -->
        <UAlert 
          v-if="aiAnalysisError"
          color="red" 
          variant="soft"
          :title="'Erro na An√°lise'"
          :description="aiAnalysisError"
          @close="aiAnalysisError = null"
          closable
        />
      </div>

      <!-- Traditional Edit Panel -->
      <div v-else-if="editingItem" class="space-y-4">
        <!-- Enhanced Header with AI Suggestions -->
        <div 
          v-if="hasPendingAISuggestions" 
          class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <UIcon name="i-heroicons-light-bulb" class="w-5 h-5 text-yellow-600" />
              <div>
                <p class="font-medium text-yellow-900">Sugest√µes de IA Dispon√≠veis</p>
                <p class="text-sm text-yellow-700">
                  Temos sugest√µes de IA para otimizar este item
                </p>
              </div>
            </div>
            <UButton
              size="sm"
              color="yellow"
              variant="soft"
              @click="applySuggestionsToCurrentItem"
            >
              Aplicar Sugest√µes
            </UButton>
          </div>
        </div>

        <!-- Timing Status Indicator (User's specific requirement) -->
        <div 
          v-if="editingItem.startTime && showTimingIndicator"
          class="p-3 rounded-lg border"
          :class="timingIndicatorClasses"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <span class="text-lg">{{ currentTimingIndicator.icon }}</span>
              <div>
                <p class="font-medium">Status de Hor√°rio</p>
                <p class="text-sm opacity-90">{{ currentTimingIndicator.message }}</p>
              </div>
            </div>
            <UBadge 
              :color="currentTimingIndicator.urgency === 'high' ? 'red' : currentTimingIndicator.urgency === 'medium' ? 'yellow' : 'green'"
              :variant="currentTimingIndicator.pulse ? 'solid' : 'soft'"
            >
              {{ timingStatus.message }}
            </UBadge>
          </div>
        </div>

        <!-- Traditional Form Fields -->
        <!-- Title with AI Enhancement -->
        <UFormGroup label="T√≠tulo" required>
          <div class="flex space-x-2">
            <UInput
              v-model="editingItem.title"
              placeholder="Digite o t√≠tulo do item"
              :ui="{ wrapper: 'relative flex-1' }"
              class="flex-1"
            />
            <UButton
              v-if="canEnhanceField('title')"
              size="sm"
              color="blue"
              variant="soft"
              icon="i-heroicons-sparkles"
              @click="enhanceFieldWithAI('title')"
              title="Melhorar com IA"
            />
          </div>
        </UFormGroup>

        <!-- Type with AI Classification -->
        <UFormGroup label="Tipo" required>
          <div class="flex space-x-2">
            <USelect
              v-model="editingItem.type"
              :options="enhancedLiturgyItemTypes"
              option-attribute="label"
              value-attribute="value"
              :ui="{ wrapper: 'relative flex-1' }"
              class="flex-1"
            />
            <UButton
              v-if="canEnhanceField('type')"
              size="sm"
              color="blue"
              variant="soft"
              icon="i-heroicons-sparkles"
              @click="enhanceFieldWithAI('type')"
              title="Classificar com IA"
            />
          </div>
        </UFormGroup>

        <!-- Description with AI Enhancement -->
        <UFormGroup label="Descri√ß√£o">
          <div class="space-y-2">
            <UTextarea
              v-model="editingItem.description"
              placeholder="Digite a descri√ß√£o do item (opcional)"
              rows="3"
              :ui="{ wrapper: 'relative' }"
            />
            <div class="flex justify-end">
              <UButton
                v-if="canEnhanceField('description')"
                size="xs"
                color="blue"
                variant="soft"
                @click="enhanceFieldWithAI('description')"
              >
                <template #leading>
                  <UIcon name="i-heroicons-sparkles" />
                </template>
                Melhorar Descri√ß√£o
              </UButton>
            </div>
          </div>
        </UFormGroup>

        <!-- Time and Duration Row with AI Timing Analysis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Start Time -->
          <UFormGroup label="Hor√°rio de In√≠cio">
            <div class="flex space-x-2">
              <UInput
                v-model="editingItem.startTime"
                placeholder="HH:mm"
                pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$"
                :ui="{ wrapper: 'relative flex-1' }"
                class="flex-1"
              />
              <UButton
                v-if="canEnhanceField('startTime')"
                size="sm"
                color="blue"
                variant="soft"
                icon="i-heroicons-clock"
                @click="enhanceFieldWithAI('startTime')"
                title="Sugerir Hor√°rio"
              />
            </div>
          </UFormGroup>

          <!-- Duration -->
          <UFormGroup label="Dura√ß√£o (minutos)">
            <div class="flex space-x-2">
              <UInput
                v-model.number="editingItem.duration"
                type="number"
                placeholder="0"
                min="0"
                :ui="{ wrapper: 'relative flex-1' }"
                class="flex-1"
              />
              <UButton
                v-if="canEnhanceField('duration')"
                size="sm"
                color="blue"
                variant="soft"
                icon="i-heroicons-clock"
                @click="enhanceFieldWithAI('duration')"
                title="Estimar Dura√ß√£o"
              />
            </div>
          </UFormGroup>
        </div>

        <!-- Responsible and Music Key Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Responsible -->
          <UFormGroup label="Respons√°vel">
            <div class="flex space-x-2">
              <UInput
                v-model="editingItem.responsible"
                placeholder="Quem √© o respons√°vel"
                :ui="{ wrapper: 'relative flex-1' }"
                class="flex-1"
              />
              <UButton
                v-if="canEnhanceField('responsible')"
                size="sm"
                color="blue"
                variant="soft"
                icon="i-heroicons-user"
                @click="enhanceFieldWithAI('responsible')"
                title="Identificar Respons√°vel"
              />
            </div>
          </UFormGroup>

          <!-- Music Key -->
          <UFormGroup label="Tom Musical">
            <UInput
              v-model="editingItem.musicKey"
              placeholder="ex: G, Am, C#"
              :ui="{ wrapper: 'relative' }"
            />
          </UFormGroup>
        </div>

        <!-- YouTube URL with Auto-Discovery -->
        <UFormGroup label="URL do YouTube">
          <div class="space-y-2">
            <UInput
              v-model="editingItem.youtubeUrl"
              placeholder="https://www.youtube.com/watch?v=..."
              type="url"
              :ui="{ wrapper: 'relative' }"
            />
            <div class="flex justify-between items-center">
              <UButton
                size="xs"
                color="red"
                variant="soft"
                icon="i-heroicons-magnifying-glass"
                @click="discoverYouTubeVideos"
                :loading="isDiscoveringVideos"
                :disabled="!editingItem.title"
              >
                Buscar V√≠deos
              </UButton>
              
              <!-- YouTube Discovery Results -->
              <div v-if="discoveredVideos.length > 0" class="text-xs text-gray-500">
                {{ discoveredVideos.length }} v√≠deo(s) encontrado(s)
              </div>
            </div>
          </div>
        </UFormGroup>

        <!-- YouTube Discovery Results -->
        <div v-if="discoveredVideos.length > 0" class="space-y-2">
          <h5 class="text-sm font-medium text-gray-700">üé• V√≠deos Encontrados:</h5>
          <div class="grid grid-cols-1 gap-2 max-h-32 overflow-y-auto">
            <div
              v-for="(video, index) in discoveredVideos"
              :key="index"
              class="p-2 border border-gray-200 rounded cursor-pointer hover:bg-blue-50 transition-colors"
              @click="selectDiscoveredVideo(video)"
            >
              <p class="text-sm font-medium">{{ video.title }}</p>
              <p class="text-xs text-gray-500">{{ video.url }}</p>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <UFormGroup label="Observa√ß√µes">
          <UTextarea
            v-model="editingItem.notes"
            placeholder="Observa√ß√µes adicionais (opcional)"
            rows="3"
            :ui="{ wrapper: 'relative' }"
          />
        </UFormGroup>

        <!-- Completed Status -->
        <UFormGroup label="Status">
          <div class="flex items-center space-x-2">
            <UCheckbox v-model="editingItem.isCompleted" name="isCompleted" />
            <span class="text-sm">Marcar como conclu√≠do</span>
          </div>
        </UFormGroup>
      </div>

      <template #footer>
        <div class="flex justify-between items-center">
          <!-- AI Analysis Controls -->
          <div v-if="showAIAnalysis" class="flex items-center space-x-2">
            <UButton
              size="sm"
              color="gray"
              variant="ghost"
              @click="clearAIAnalysis"
              :disabled="isAnalyzing"
            >
              Limpar An√°lise
            </UButton>
            
            <!-- AI Confidence Threshold -->
            <div class="flex items-center space-x-2 text-xs text-gray-500">
              <span>Confian√ßa m√≠n:</span>
              <select 
                v-model.number="aiConfidenceThreshold"
                class="px-2 py-1 border border-gray-300 rounded text-xs"
                @change="updateConfidenceThreshold"
              >
                <option :value="0.01">1%</option>
                <option :value="0.05">5%</option>
                <option :value="0.1">10%</option>
                <option :value="0.3">30%</option>
                <option :value="0.5">50%</option>
              </select>
            </div>
          </div>
          
          <!-- Traditional Controls -->
          <div v-else class="flex items-center space-x-2">
            <!-- Resource Discovery -->
            <UButton
              v-if="editingItem?.title"
              size="sm"
              color="blue"
              variant="soft"
              @click="discoverResources"
              :loading="isDiscoveringResources"
            >
              <template #leading>
                <UIcon name="i-heroicons-link" />
              </template>
              Buscar Recursos
            </UButton>
          </div>

          <!-- Main Actions -->
          <div class="flex justify-end space-x-3">
            <UButton color="gray" variant="ghost" @click="closeModal">
              Cancelar
            </UButton>
            
            <UButton
              v-if="!showAIAnalysis"
              color="primary"
              @click="saveChanges"
              :disabled="!isValid"
              :loading="isSaving"
            >
              Salvar Altera√ß√µes
            </UButton>
          </div>
        </div>
      </template>
    </UCard>
  </UModal>
</template>

<script setup lang="ts">
import type { LiturgyItem, LiturgyItemType } from "@church-copilot/shared";
import { useAILiturgy } from "~/composables/useAILiturgy";

// Props
interface Props {
  modelValue: boolean;
  item?: LiturgyItem | null;
}

// Emits
interface Emits {
  (e: "update:modelValue", value: boolean): void;
  (e: "save", item: LiturgyItem): void;
  (e: "saveMultiple", items: LiturgyItem[]): void;
}

const props = defineProps<Props>();
const emit = defineEmits<Emits>();

// AI Liturgy Composable
const {
  analyzeLiturgyProgram: aiAnalyzeLiturgyProgram,
  generateTimeline,
  findResourcesForMoment,
  researchVideosForMoment,
  checkTimingStatus,
  getTimingIndicator,
  overrideAIClassification,
  adjustConfidenceThreshold,
  isAnalyzing,
  lastAnalysis,
  moments: aiMoments,
  error: aiError
} = useAILiturgy({
  debugMode: true,
  confidenceThreshold: 0.05
});

// Reactive states
const isOpen = computed({
  get: () => props.modelValue,
  set: (value) => emit("update:modelValue", value),
});

const isSaving = ref(false);
const editingItem = ref<LiturgyItem | null>(null);

// AI Analysis States
const showAIAnalysis = ref(false);
const liturgyProgramText = ref("");
const aiAnalysisResults = ref<any[]>([]);
const aiAnalysisError = ref<string | null>(null);
const aiConfidenceThreshold = ref(0.05);

// Resource Discovery States  
const isDiscoveringResources = ref(false);
const isDiscoveringVideos = ref(false);
const discoveredVideos = ref<any[]>([]);

// Timing Indicator States
const showTimingIndicator = ref(true);
const currentTime = ref(new Date());

// Enhanced liturgy item types with Portuguese labels
const enhancedLiturgyItemTypes = [
  { value: "OPENING", label: "üö™ Abertura do Culto" },
  { value: "PRAYER", label: "üôè Ora√ß√£o" },
  { value: "MUSIC", label: "üéµ C√¢ntico Congregacional" },
  { value: "SPECIAL_MUSIC", label: "üé∂ Louvor Especial" },
  { value: "READING", label: "üìñ Leitura B√≠blica" },
  { value: "MESSAGE", label: "üí¨ Mensagem/Serm√£o" },
  { value: "OFFERING", label: "üí∞ Ofertas/D√≠zimos" },
  { value: "ANNOUNCEMENT", label: "üì¢ Avisos" },
  { value: "MOMENT", label: "‚ú® Momento Especial" },
  { value: "CLOSING", label: "üîö Encerramento/B√™n√ß√£o" },
  { value: "PRELUDE", label: "üéº Prel√∫dio" },
  { value: "POSTLUDE", label: "üéº Posl√∫dio" },
  { value: "BREAK", label: "‚è∏Ô∏è Intervalo" },
  { value: "OTHER", label: "üìã Outros" },
] as const;

// Computed Properties
const isValid = computed(() => {
  if (!editingItem.value) return false;
  return editingItem.value.title.trim().length > 0;
});

const hasPendingAISuggestions = computed(() => {
  return aiMoments.value.length > 0;
});

const timingStatus = computed(() => {
  if (!editingItem.value?.startTime) return null;
  return checkTimingStatus(editingItem.value as any, currentTime.value);
});

const currentTimingIndicator = computed(() => {
  if (!timingStatus.value) return null;
  return getTimingIndicator(timingStatus.value);
});

const timingIndicatorClasses = computed(() => {
  if (!currentTimingIndicator.value) return '';
  
  const indicator = currentTimingIndicator.value;
  const baseClasses = "transition-all duration-300";
  
  switch (indicator.urgency) {
    case 'high':
      return `${baseClasses} bg-red-50 border-red-200 text-red-900 ${indicator.pulse ? 'animate-pulse' : ''}`;
    case 'medium':
      return `${baseClasses} bg-yellow-50 border-yellow-200 text-yellow-900 ${indicator.pulse ? 'animate-pulse' : ''}`;
    default:
      return `${baseClasses} bg-green-50 border-green-200 text-green-900`;
  }
});

// Watch for item changes
watch(
  () => props.item,
  (newItem) => {
    if (newItem) {
      // Create a deep copy of the item for editing
      editingItem.value = {
        ...newItem,
        description: newItem.description || "",
        startTime: newItem.startTime || "",
        duration: newItem.duration || undefined,
        responsible: newItem.responsible || "",
        youtubeUrl: newItem.youtubeUrl || "",
        musicKey: newItem.musicKey || "",
        notes: newItem.notes || "",
      };
    } else {
      editingItem.value = null;
    }
  },
  { immediate: true }
);

// Watch AI analysis results
watch(
  () => lastAnalysis.value,
  (analysis) => {
    if (analysis) {
      aiAnalysisResults.value = analysis.moments || [];
    }
  }
);

// Watch AI errors
watch(
  () => aiError.value,
  (error) => {
    aiAnalysisError.value = error;
  }
);

// Update current time every minute for timing indicators
onMounted(() => {
  const timeInterval = setInterval(() => {
    currentTime.value = new Date();
  }, 60000); // Update every minute

  onUnmounted(() => {
    clearInterval(timeInterval);
  });
});

// Methods
const toggleAIAnalysis = () => {
  showAIAnalysis.value = !showAIAnalysis.value;
  
  if (showAIAnalysis.value) {
    // Clear previous analysis when switching to AI mode
    clearAIAnalysis();
  }
};

const analyzeLiturgyProgram = async () => {
  if (!liturgyProgramText.value.trim()) return;

  try {
    await aiAnalyzeLiturgyProgram(liturgyProgramText.value);
  } catch (error) {
    console.error('AI analysis failed:', error);
  }
};

const clearAIAnalysis = () => {
  liturgyProgramText.value = "";
  aiAnalysisResults.value = [];
  aiAnalysisError.value = null;
  discoveredVideos.value = [];
};

const updateConfidenceThreshold = () => {
  adjustConfidenceThreshold(aiConfidenceThreshold.value);
};

const getTypeColor = (type: string): string => {
  const colors: Record<string, string> = {
    'C√¢ntico': 'blue',
    'Ora√ß√£o': 'purple',
    'Leitura B√≠blica': 'green',
    'Mensagem': 'yellow',
    'Avisos': 'gray',
    'B√™n√ß√£o': 'purple',
    'Prel√∫dio': 'indigo',
    'Momento Musical': 'blue',
  };
  return colors[type] || 'gray';
};

const getTypeLabel = (type: string): string => {
  const labels: Record<string, string> = {
    'C√¢ntico': 'üéµ C√¢ntico',
    'Ora√ß√£o': 'üôè Ora√ß√£o', 
    'Leitura B√≠blica': 'üìñ Leitura',
    'Mensagem': 'üí¨ Mensagem',
    'Avisos': 'üì¢ Avisos',
    'B√™n√ß√£o': '‚ú® B√™n√ß√£o',
    'Prel√∫dio': 'üéº Prel√∫dio',
    'Momento Musical': 'üé∂ Momento Musical',
  };
  return labels[type] || `üìã ${type}`;
};

const applyAIResult = (result: any, index: number) => {
  // Convert AI result to LiturgyItem format
  const liturgyItem: LiturgyItem = {
    id: Date.now() + index, // Temporary ID
    title: result.title,
    type: mapAITypeToLiturgyType(result.type),
    description: result.description || "",
    startTime: result.startTime || "",
    duration: result.duration || undefined,
    responsible: result.responsible || "",
    youtubeUrl: "",
    musicKey: "",
    notes: `Gerado por IA (${Math.round(result.confidence * 100)}% confian√ßa)`,
    isCompleted: false,
    createdAt: new Date(),
    updatedAt: new Date(),
  };

  // Switch to manual edit mode and load the result
  showAIAnalysis.value = false;
  editingItem.value = liturgyItem;
};

const applyAllAIResults = () => {
  const liturgyItems: LiturgyItem[] = aiAnalysisResults.value.map((result, index) => ({
    id: Date.now() + index,
    title: result.title,
    type: mapAITypeToLiturgyType(result.type),
    description: result.description || "",
    startTime: result.startTime || "",
    duration: result.duration || undefined,
    responsible: result.responsible || "",
    youtubeUrl: "",
    musicKey: "",
    notes: `Gerado por IA (${Math.round(result.confidence * 100)}% confian√ßa)`,
    isCompleted: false,
    createdAt: new Date(),
    updatedAt: new Date(),
  }));

  emit("saveMultiple", liturgyItems);
  closeModal();
};

const editAIResult = (result: any, index: number) => {
  // Apply the result and switch to edit mode
  applyAIResult(result, index);
};

const mapAITypeToLiturgyType = (aiType: string): LiturgyItemType => {
  const mapping: Record<string, LiturgyItemType> = {
    'C√¢ntico': 'MUSIC',
    'Ora√ß√£o': 'PRAYER',
    'Leitura B√≠blica': 'READING',
    'Mensagem': 'MESSAGE',
    'Avisos': 'ANNOUNCEMENT',
    'B√™n√ß√£o': 'CLOSING',
    'Prel√∫dio': 'PRELUDE',
    'Momento Musical': 'SPECIAL_MUSIC',
  };
  return mapping[aiType] || 'OTHER';
};

const canEnhanceField = (field: string): boolean => {
  // Check if AI suggestions are available for this field
  return hasPendingAISuggestions.value;
};

const enhanceFieldWithAI = async (field: string) => {
  // Implement field-specific AI enhancement
  console.log(`Enhancing field: ${field} with AI`);
};

const applySuggestionsToCurrentItem = () => {
  // Apply AI suggestions to current editing item
  console.log('Applying AI suggestions to current item');
};

const discoverYouTubeVideos = async () => {
  if (!editingItem.value?.title) return;

  isDiscoveringVideos.value = true;
  try {
    const videos = await researchVideosForMoment(editingItem.value as any);
    discoveredVideos.value = videos;
  } catch (error) {
    console.error('Video discovery failed:', error);
  } finally {
    isDiscoveringVideos.value = false;
  }
};

const selectDiscoveredVideo = (video: any) => {
  if (editingItem.value) {
    editingItem.value.youtubeUrl = video.url;
  }
  discoveredVideos.value = [];
};

const discoverResources = async () => {
  if (!editingItem.value?.title) return;

  isDiscoveringResources.value = true;
  try {
    await findResourcesForMoment(editingItem.value as any);
  } catch (error) {
    console.error('Resource discovery failed:', error);
  } finally {
    isDiscoveringResources.value = false;
  }
};

const closeModal = () => {
  isOpen.value = false;
  editingItem.value = null;
  clearAIAnalysis();
  showAIAnalysis.value = false;
};

const saveChanges = async () => {
  if (!editingItem.value || !isValid.value) return;

  try {
    isSaving.value = true;

    // Clean up empty strings and undefined values
    const updatedItem: LiturgyItem = {
      ...editingItem.value,
      description: editingItem.value.description?.trim() || undefined,
      startTime: editingItem.value.startTime?.trim() || undefined,
      responsible: editingItem.value.responsible?.trim() || undefined,
      youtubeUrl: editingItem.value.youtubeUrl?.trim() || undefined,
      musicKey: editingItem.value.musicKey?.trim() || undefined,
      notes: editingItem.value.notes?.trim() || undefined,
      updatedAt: new Date(),
    };

    emit("save", updatedItem);
    closeModal();
  } catch (error) {
    console.error("Failed to save liturgy item:", error);
  } finally {
    isSaving.value = false;
  }
};

// Handle ESC key
onMounted(() => {
  const handleEscape = (e: KeyboardEvent) => {
    if (e.key === "Escape" && isOpen.value) {
      closeModal();
    }
  };

  document.addEventListener("keydown", handleEscape);

  onUnmounted(() => {
    document.removeEventListener("keydown", handleEscape);
  });
});
</script>

<style scoped>
.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: .5;
  }
}
</style>
